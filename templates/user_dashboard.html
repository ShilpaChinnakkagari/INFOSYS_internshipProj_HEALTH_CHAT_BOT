{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Sidebar -->
        <div class="col-md-3">
            <!-- User Profile Card -->
            <div class="card shadow-sm mb-4">
                <div class="card-body text-center">
                    <img src="https://ui-avatars.com/api/?name={{ current_user.name }}&background=007bff&color=fff&size=100" 
                         class="rounded-circle mb-3 border" alt="Profile">
                    <h5 class="card-title">{{ current_user.name }}</h5>
                    <p class="text-muted mb-2">{{ current_user.email }}</p>
                    <div class="d-flex justify-content-around text-center mb-3">
                        <div>
                            <div class="fw-bold text-primary">{{ health_scores|length }}</div>
                            <small class="text-muted">Scores</small>
                        </div>
                        <div>
                            <div class="fw-bold text-success">{{ chat_history|length }}</div>
                            <small class="text-muted">Chats</small>
                        </div>
                    </div>
                    <p class="small text-muted mb-1">
                        <i class="fas fa-map-marker-alt"></i> {{ current_user.location }}
                    </p>
                    <p class="small text-muted">
                        <i class="fas fa-birthday-cake"></i> Age: {{ current_user.age }}
                    </p>
                </div>
            </div>

            <!-- Navigation -->
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="nav flex-column">
                        <button class="btn btn-outline-primary text-start mb-2 active" onclick="showSection('chat')">
                            <i class="fas fa-comment-medical"></i> Health Chat
                        </button>
                        <button class="btn btn-outline-success text-start mb-2" onclick="showSection('health')">
                            <i class="fas fa-chart-line"></i> Health Progress
                        </button>
                        <button class="btn btn-outline-info text-start mb-2" onclick="showSection('chat-history')">
                            <i class="fas fa-history"></i> Chat History
                        </button>
                        <button class="btn btn-outline-secondary text-start mb-2" onclick="showSection('profile')">
                            <i class="fas fa-user-cog"></i> Profile Settings
                        </button>
                    </div>
                </div>
            </div>

            <!-- Emergency Button -->
            <button class="btn btn-danger btn-lg w-100 mt-4 emergency-btn shadow" onclick="triggerEmergency()">
                <i class="fas fa-ambulance"></i> EMERGENCY
            </button>

            <!-- Quick Health Score -->
            {% if health_scores %}
            <div class="card mt-4 shadow-sm">
                <div class="card-body text-center">
                    <h6>Current Health Score</h6>
                    <div class="health-score-circle mx-auto mb-2">
                        {{ health_scores[0].score if health_scores else 'N/A' }}
                    </div>
                    <small class="text-muted">Last updated: {{ health_scores[0].date.strftime('%m/%d/%Y') if health_scores else 'Never' }}</small>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Main Content -->
        <div class="col-md-9">
            <!-- Chat Section -->
            <div id="chat-section" class="dashboard-section">
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-comment-medical"></i> Health Assistant</h5>
                    </div>
                    <div class="card-body">
                        <div id="chat-container" class="chat-container border rounded p-3 mb-3 bg-light">
                            <div class="alert alert-info">
                                <strong><i class="fas fa-robot"></i> HealthBot:</strong> 
                                Hello {{ current_user.name }}! I'm your health assistant. Describe your symptoms in English or Hindi, and I'll provide helpful advice.
                            </div>
                        </div>
                        <div class="input-group">
                            <input type="text" id="chat-input" class="form-control" 
                                   placeholder="Describe your symptoms in English or Hindi (e.g., ‡§∏‡§ø‡§∞‡§¶‡§∞‡•ç‡§¶, fever, headache)..."
                                   onkeypress="if(event.key === 'Enter') sendMessage()">
                            <button class="btn btn-primary" onclick="sendMessage()">
                                <i class="fas fa-paper-plane"></i> Send
                            </button>
                        </div>

                        <div class="mt-2 text-center">
                            <small class="text-muted">
                                <i class="fas fa-language"></i> Supports English & Hindi | 
                                <i class="fas fa-shield-alt"></i> Your conversations are private
                            </small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Health Progress Section -->
            <div id="health-section" class="dashboard-section" style="display:none">
                <div class="card shadow-sm">
                    <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-chart-line"></i> Health Progress Tracking</h5>
                        <button class="btn btn-light btn-sm" onclick="updateHealthScorePrompt()">
                            <i class="fas fa-plus"></i> Add Score
                        </button>
                    </div>
                    <div class="card-body">
                        {% if chart_url %}
                        <div class="text-center mb-4">
                            <img src="{{ chart_url }}" alt="Health Progress Chart" class="img-fluid rounded shadow">
                        </div>
                        {% endif %}
                        
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Date</th>
                                        <th>Score</th>
                                        <th>Status</th>
                                        <th>Notes</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for score in health_scores %}
                                    <tr>
                                        <td>{{ score.date.strftime('%Y-%m-%d') }}</td>
                                        <td>
                                            <span class="badge bg-{% if score.score >= 80 %}success{% elif score.score >= 60 %}warning{% else %}danger{% endif %} fs-6">
                                                {{ score.score }}/100
                                            </span>
                                        </td>
                                        <td>
                                            {% if score.score >= 80 %}
                                                <span class="text-success"><i class="fas fa-smile"></i> Excellent</span>
                                            {% elif score.score >= 60 %}
                                                <span class="text-warning"><i class="fas fa-meh"></i> Good</span>
                                            {% else %}
                                                <span class="text-danger"><i class="fas fa-frown"></i> Needs Attention</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ score.notes or 'No notes' }}</td>
                                        <td>
                                            <button class="btn btn-sm btn-outline-danger" 
                                                    onclick="deleteHealthScore({{ score.id }})">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    {% else %}
                                    <tr>
                                        <td colspan="5" class="text-center text-muted py-4">
                                            <i class="fas fa-chart-line fa-3x mb-3"></i>
                                            <p>No health scores recorded yet.</p>
                                            <button class="btn btn-primary" onclick="updateHealthScorePrompt()">
                                                Add Your First Health Score
                                            </button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Chat History Section -->
            <div id="chat-history-section" class="dashboard-section" style="display:none">
                <div class="card shadow-sm">
                    <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-history"></i> Chat History</h5>
                        {% if chat_history %}
                        <button class="btn btn-light btn-sm" onclick="clearAllChats()">
                            <i class="fas fa-trash"></i> Clear All
                        </button>
                        {% endif %}
                    </div>
                    <div class="card-body">
                        {% if chat_history %}
                        <div style="max-height: 600px; overflow-y: auto;">
                            {% for chat in chat_history %}
                            <div class="card mb-3 shadow-sm">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <small class="text-muted">
                                            <i class="fas fa-clock"></i> {{ chat.timestamp.strftime('%Y-%m-%d %H:%M') }}
                                        </small>
                                        <button class="btn btn-sm btn-outline-danger" 
                                                onclick="deleteChat({{ chat.id }})">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                    <div class="user-message p-2 rounded mb-2">
                                        <strong><i class="fas fa-user"></i> You:</strong><br>
                                        {{ chat.message }}
                                    </div>
                                    <div class="bot-message p-2 rounded">
                                        <strong><i class="fas fa-robot"></i> HealthBot:</strong><br>
                                        {{ chat.response }}
                                    </div>
                                    <!-- Feedback buttons for each chat in history -->
                                    <div class="feedback-section mt-2 text-center">
                                        {% if chat.feedback %}
                                            {% if chat.feedback.feedback == 'thumbs_up' %}
                                                <span class="text-success">
                                                    <i class="fas fa-thumbs-up"></i> You found this helpful
                                                </span>
                                            {% else %}
                                                <span class="text-danger">
                                                    <i class="fas fa-thumbs-down"></i> You didn't find this helpful
                                                    {% if chat.feedback.reason %}
                                                        <br><small class="text-muted">Reason: {{ chat.feedback.reason }}</small>
                                                    {% endif %}
                                                </span>
                                            {% endif %}
                                        {% else %}
                                            <div class="btn-group" role="group">
                                                <button type="button" class="btn btn-sm btn-outline-danger" 
                                                        onclick="submitFeedbackFromHistory({{ chat.id }}, 'thumbs_down')">
                                                    <i class="fas fa-thumbs-down"></i> Not Helpful
                                                </button>
                                                <button type="button" class="btn btn-sm btn-outline-success" 
                                                        onclick="submitFeedbackFromHistory({{ chat.id }}, 'thumbs_up')">
                                                    <i class="fas fa-thumbs-up"></i> Helpful
                                                </button>
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-comments fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No Chat History</h5>
                            <p class="text-muted">Your conversations with HealthBot will appear here.</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Profile Section -->
            <div id="profile-section" class="dashboard-section" style="display:none">
                <div class="card shadow-sm">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="mb-0"><i class="fas fa-user-cog"></i> Profile Settings</h5>
                    </div>
                    <div class="card-body">
                        <form id="profile-form">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Full Name *</label>
                                    <input type="text" class="form-control" name="name" value="{{ current_user.name }}" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Age *</label>
                                    <input type="number" class="form-control" name="age" value="{{ current_user.age }}" min="1" max="120" required>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Email Address</label>
                                <input type="email" class="form-control" value="{{ current_user.email }}" readonly>
                                <div class="form-text">Email cannot be changed</div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Location *</label>
                                <input type="text" class="form-control" name="location" value="{{ current_user.location }}" required>
                                <div class="form-text">Used for emergency services</div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Preferred Language</label>
                                <select class="form-select" name="language">
                                    <option value="en" {% if current_user.language == 'en' %}selected{% endif %}>English</option>
                                    <option value="hi" {% if current_user.language == 'hi' %}selected{% endif %}>Hindi (‡§π‡§ø‡§®‡•ç‡§¶‡•Ä)</option>
                                    <option value="es" {% if current_user.language == 'es' %}selected{% endif %}>Spanish</option>
                                    <option value="fr" {% if current_user.language == 'fr' %}selected{% endif %}>French</option>
                                </select>
                                <div class="form-text">HealthBot will respond in your preferred language when possible</div>
                            </div>
                            <div class="text-end">
                                <button type="button" class="btn btn-primary" onclick="updateProfile()">
                                    <i class="fas fa-save"></i> Update Profile
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Health Score Modal -->
<div class="modal fade" id="healthScoreModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Update Health Score</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Health Score (0-100)</label>
                    <input type="range" class="form-range" id="health-score-range" min="0" max="100" value="50">
                    <div class="text-center">
                        <span id="score-display" class="fw-bold fs-4 text-primary">50</span>/100
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Notes (Optional)</label>
                    <textarea class="form-control" id="health-notes-input" rows="3" 
                              placeholder="How are you feeling today? Any specific concerns?"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="updateHealthScore()">Save Score</button>
            </div>
        </div>
    </div>
</div>

<!-- Reason Modal for Thumbs Down -->
<div class="modal fade" id="reasonModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Why was this response unhelpful?</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="feedbackChatId">
                <input type="hidden" id="feedbackType">
                <div class="mb-3">
                    <label class="form-label">Optional reason (help us improve):</label>
                    <textarea class="form-control" id="feedbackReason" rows="3" 
                             placeholder="e.g., The advice was unclear, didn't address my symptoms, etc."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="submitFeedbackWithReason()">Submit Feedback</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentChatId = null;

// Navigation
function showSection(section) {
    document.querySelectorAll('.dashboard-section').forEach(div => div.style.display = 'none');
    document.querySelectorAll('.btn-outline-primary').forEach(btn => btn.classList.remove('active'));
    document.getElementById(section + '-section').style.display = 'block';
    event.target.classList.add('active');
}

// Chat functionality with feedback for EVERY message
function sendMessage() {
    const input = document.getElementById('chat-input');
    const message = input.value.trim();
    if (message) {
        const chatContainer = document.getElementById('chat-container');
        
        // Add user message
        chatContainer.innerHTML += `
            <div class="d-flex justify-content-end mb-2">
                <div class="user-message p-2" style="max-width: 70%;">
                    <strong>You:</strong> ${message}
                </div>
            </div>
        `;
        input.value = '';
        
        // Show typing indicator
        chatContainer.innerHTML += `
            <div class="d-flex justify-content-start mb-2">
                <div class="bot-message p-2" style="max-width: 70%;">
                    <strong>HealthBot:</strong> <i class="fas fa-ellipsis-h"></i>
                </div>
            </div>
        `;
        chatContainer.scrollTop = chatContainer.scrollHeight;
        
        // Send to server
        fetch('/chat', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({message: message})
        })
        .then(r => r.json())
        .then(data => {
            // Remove typing indicator and add response
            chatContainer.querySelector('.fa-ellipsis-h').parentElement.parentElement.remove();
            
            // Add bot response with feedback buttons
            const responseHtml = `
                <div class="d-flex justify-content-start mb-2">
                    <div class="bot-message p-2" style="max-width: 70%;">
                        <strong>HealthBot:</strong> ${data.response}
                    </div>
                </div>
                <div class="feedback-section text-center mb-3">
                    <small class="text-muted d-block mb-1">Was this helpful?</small>
                    <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn btn-outline-danger" 
                                onclick="showReasonModal('${data.chat_id}', 'thumbs_down')">
                            <i class="fas fa-thumbs-down"></i> Not Helpful
                        </button>
                        <button type="button" class="btn btn-outline-success" 
                                onclick="submitFeedback('${data.chat_id}', 'thumbs_up')">
                            <i class="fas fa-thumbs-up"></i> Helpful
                        </button>
                    </div>
                </div>
            `;
            chatContainer.innerHTML += responseHtml;
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            currentChatId = data.chat_id;
        })
        .catch(error => {
            console.error('Chat error:', error);
            // Remove typing indicator
            chatContainer.querySelector('.fa-ellipsis-h').parentElement.parentElement.remove();
            // Show error message
            chatContainer.innerHTML += `
                <div class="d-flex justify-content-start mb-2">
                    <div class="bot-message p-2" style="max-width: 70%;">
                        <strong>HealthBot:</strong> Sorry, I encountered an error. Please try again.
                    </div>
                </div>
            `;
            chatContainer.scrollTop = chatContainer.scrollHeight;
        });
    }
}

// Feedback functions
function showReasonModal(chatId, feedbackType) {
    document.getElementById('feedbackChatId').value = chatId;
    document.getElementById('feedbackType').value = feedbackType;
    
    // Show the modal
    const modal = new bootstrap.Modal(document.getElementById('reasonModal'));
    modal.show();
}

function submitFeedbackWithReason() {
    const chatId = document.getElementById('feedbackChatId').value;
    const feedbackType = document.getElementById('feedbackType').value;
    const reason = document.getElementById('feedbackReason').value;
    
    submitFeedbackDirect(chatId, feedbackType, reason);
    
    // Hide modal and reset
    const modal = bootstrap.Modal.getInstance(document.getElementById('reasonModal'));
    modal.hide();
    document.getElementById('feedbackReason').value = '';
}

function submitFeedback(chatId, feedbackType) {
    submitFeedbackDirect(chatId, feedbackType, '');
}

function submitFeedbackDirect(chatId, feedbackType, reason) {
    fetch('/chat/feedback', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            chat_id: chatId,
            feedback: feedbackType,
            reason: reason
        })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            // Update UI to show feedback was recorded
            const feedbackSection = document.querySelector(`[onclick*="${chatId}"]`).closest('.feedback-section');
            if (feedbackType === 'thumbs_up') {
                feedbackSection.innerHTML = `
                    <span class="text-success">
                        <i class="fas fa-thumbs-up"></i> Thank you for your feedback!
                    </span>
                `;
            } else {
                let html = `<span class="text-danger"><i class="fas fa-thumbs-down"></i> Thank you for your feedback!</span>`;
                if (reason) {
                    html += `<br><small class="text-muted">Reason: ${reason}</small>`;
                }
                feedbackSection.innerHTML = html;
            }
        } else {
            alert('Error submitting feedback: ' + (data.message || 'Please try again.'));
        }
    })
    .catch(error => {
        console.error('Feedback error:', error);
        alert('Error submitting feedback. Please try again.');
    });
}

// Feedback for chat history
function submitFeedbackFromHistory(chatId, feedbackType) {
    if (feedbackType === 'thumbs_down') {
        document.getElementById('feedbackChatId').value = chatId;
        document.getElementById('feedbackType').value = feedbackType;
        const modal = new bootstrap.Modal(document.getElementById('reasonModal'));
        modal.show();
    } else {
        submitFeedbackDirect(chatId, feedbackType, '');
    }
}

// Health score functionality
function updateHealthScorePrompt() {
    const modal = new bootstrap.Modal(document.getElementById('healthScoreModal'));
    const range = document.getElementById('health-score-range');
    const display = document.getElementById('score-display');
    
    // Reset values
    range.value = 50;
    display.textContent = '50';
    document.getElementById('health-notes-input').value = '';
    
    range.addEventListener('input', function() {
        display.textContent = this.value;
        
        // Update color based on score
        const score = parseInt(this.value);
        if (score >= 80) {
            display.className = 'fw-bold fs-4 text-success';
        } else if (score >= 60) {
            display.className = 'fw-bold fs-4 text-warning';
        } else {
            display.className = 'fw-bold fs-4 text-danger';
        }
    });
    
    modal.show();
}

function updateHealthScore() {
    const score = document.getElementById('health-score-range').value;
    const notes = document.getElementById('health-notes-input').value;
    
    if (!score) {
        alert('Please set a health score.');
        return;
    }
    
    fetch('/health/score', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({score: parseInt(score), notes: notes})
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('healthScoreModal')).hide();
            // Show success message
            const healthSection = document.getElementById('health-section');
            const successAlert = `
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    <i class="fas fa-check-circle"></i> Health score updated successfully!
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            healthSection.querySelector('.card-body').insertAdjacentHTML('afterbegin', successAlert);
            
            // Reload the page after a short delay to show updated data
            setTimeout(() => {
                location.reload();
            }, 1500);
        } else {
            alert('Error updating health score: ' + (data.message || 'Please try again.'));
        }
    })
    .catch(error => {
        console.error('Health score error:', error);
        alert('Error updating health score. Please try again.');
    });
}

function deleteHealthScore(scoreId) {
    if (confirm('Are you sure you want to delete this health score record?')) {
        fetch(`/health/score/${scoreId}`, {
            method: 'DELETE'
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error deleting health score: ' + (data.message || 'Please try again.'));
            }
        })
        .catch(error => {
            console.error('Delete health score error:', error);
            alert('Error deleting health score. Please try again.');
        });
    }
}

// Chat management
function deleteChat(chatId) {
    if (confirm('Are you sure you want to delete this chat?')) {
        fetch(`/chat/delete/${chatId}`, {
            method: 'DELETE'
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error deleting chat: ' + (data.message || 'Please try again.'));
            }
        })
        .catch(error => {
            console.error('Delete chat error:', error);
            alert('Error deleting chat. Please try again.');
        });
    }
}

function clearAllChats() {
    if (confirm('Are you sure you want to clear all chat history? This action cannot be undone.')) {
        fetch('/chat/clear_all', {
            method: 'DELETE'
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error clearing chats: ' + (data.message || 'Please try again.'));
            }
        })
        .catch(error => {
            console.error('Clear chats error:', error);
            alert('Error clearing chats. Please try again.');
        });
    }
}

// Profile management
function updateProfile() {
    const form = document.getElementById('profile-form');
    const name = form.name.value.trim();
    const age = form.age.value;
    const location = form.location.value.trim();
    const language = form.language.value;
    
    // Basic validation
    if (!name) {
        alert('Please enter your name.');
        return;
    }
    if (!age || age < 1 || age > 120) {
        alert('Please enter a valid age (1-120).');
        return;
    }
    if (!location) {
        alert('Please enter your location.');
        return;
    }
    
    const data = {
        name: name,
        age: parseInt(age),
        location: location,
        language: language
    };
    
    fetch('/profile/update', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            // Show success message
            const profileSection = document.getElementById('profile-section');
            const successAlert = `
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    <i class="fas fa-check-circle"></i> Profile updated successfully!
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            profileSection.querySelector('.card-body').insertAdjacentHTML('afterbegin', successAlert);
            
            // Update the sidebar name immediately
            document.querySelector('.card-title').textContent = name;
            
            // Reload after a short delay to ensure all data is updated
            setTimeout(() => {
                location.reload();
            }, 1000);
        } else {
            alert('Error updating profile: ' + (data.message || 'Please try again.'));
        }
    })
    .catch(error => {
        console.error('Profile update error:', error);
        alert('Error updating profile. Please try again.');
    });
}

// Emergency functionality
function triggerEmergency() {
    if (confirm('üö® EMERGENCY ALERT!\n\nThis will simulate notifying emergency services with your location.\n\nIn a real emergency, please call your local emergency number immediately!\n\nContinue with simulation?')) {
        // Show loading state
        const button = event.target;
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> NOTIFYING...';
        button.disabled = true;
        
        fetch('/emergency', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        })
        .then(r => r.json())
        .then(data => {
            // Restore button
            button.innerHTML = originalText;
            button.disabled = false;
            
            if (data.success) {
                alert(`üöë EMERGENCY SERVICES NOTIFIED!\n\n${data.message}\n\nHospital: ${data.hospital.name}\nAddress: ${data.hospital.address}\nPhone: ${data.hospital.phone}\nDistance: ${data.hospital.distance}\n\nRemember: This is a simulation. In a real emergency, call your local emergency number!`);
            } else {
                alert('Emergency service temporarily unavailable. Please call local emergency services immediately!\n\nIn India: 112\nIn US: 911\nIn UK: 999');
            }
        })
        .catch(error => {
            console.error('Emergency error:', error);
            // Restore button
            button.innerHTML = originalText;
            button.disabled = false;
            alert('Emergency service error. Please call local emergency services immediately!\n\nIn India: 112\nIn US: 911\nIn UK: 999');
        });
    }
}

// Enter key support for chat input
document.getElementById('chat-input').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        sendMessage();
    }
});

// Auto-scroll chat to bottom when section is shown
function showSection(section) {
    document.querySelectorAll('.dashboard-section').forEach(div => div.style.display = 'none');
    document.querySelectorAll('.btn-outline-primary').forEach(btn => btn.classList.remove('active'));
    document.getElementById(section + '-section').style.display = 'block';
    event.target.classList.add('active');
    
    // Auto-scroll chat container to bottom when chat section is shown
    if (section === 'chat') {
        setTimeout(() => {
            const chatContainer = document.getElementById('chat-container');
            if (chatContainer) {
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
        }, 100);
    }
}

// Initialize
showSection('chat');
</script>

<style>
.health-score-circle {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    font-weight: bold;
    border: 4px solid #e9ecef;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.user-message {
    background: linear-gradient(135deg, #007bff, #0056b3);
    color: white;
    border: none;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.bot-message {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
}

.emergency-btn {
    background: linear-gradient(45deg, #ff416c, #ff4b2b);
    border: none;
    animation: pulse 2s infinite;
    font-weight: bold;
    box-shadow: 0 4px 15px rgba(255, 65, 108, 0.4);
    transition: all 0.3s ease;
}

.emergency-btn:hover {
    transform: scale(1.05);
    box-shadow: 0 6px 20px rgba(255, 65, 108, 0.6);
}

.emergency-btn:disabled {
    opacity: 0.7;
    transform: none;
    animation: none;
}

@keyframes pulse {
    0% { 
        transform: scale(1); 
        box-shadow: 0 0 0 0 rgba(255, 65, 108, 0.7); 
    }
    50% { 
        transform: scale(1.05); 
        box-shadow: 0 0 0 10px rgba(255, 65, 108, 0); 
    }
    100% { 
        transform: scale(1); 
        box-shadow: 0 0 0 0 rgba(255, 65, 108, 0); 
    }
}

.chat-container {
    height: 400px;
    overflow-y: auto;
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    padding: 1rem;
}

.btn-outline-primary.active {
    background-color: #007bff;
    color: white;
    border-color: #007bff;
    box-shadow: 0 2px 4px rgba(0, 123, 255, 0.3);
}

.card {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

.feedback-section {
    transition: all 0.3s ease;
}

.health-score-range {
    width: 100%;
    height: 8px;
    border-radius: 4px;
    background: #ddd;
    outline: none;
}

.health-score-range::-webkit-slider-thumb {
    appearance: none;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: #007bff;
    cursor: pointer;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

.health-score-range::-moz-range-thumb {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: #007bff;
    cursor: pointer;
    border: none;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .health-score-circle {
        width: 60px;
        height: 60px;
        font-size: 1.2rem;
    }
    
    .chat-container {
        height: 300px;
    }
    
    .user-message, .bot-message {
        max-width: 90% !important;
    }
}

/* Scrollbar styling */
.chat-container::-webkit-scrollbar {
    width: 6px;
}

.chat-container::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 3px;
}

.chat-container::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 3px;
}

.chat-container::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

.feedback-section .btn-group {
    margin-top: 5px;
}

.feedback-section small {
    font-size: 0.8rem;
}
</style>
{% endblock %}