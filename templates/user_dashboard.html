{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Sidebar -->
        <div class="col-md-3">
            <!-- User Profile Card -->
            <div class="card shadow-sm mb-4">
                <div class="card-body text-center">
                    <img src="https://ui-avatars.com/api/?name={{ current_user.name }}&background=007bff&color=fff&size=100" 
                         class="rounded-circle mb-3 border" alt="Profile">
                    <h5 class="card-title">{{ current_user.name }}</h5>
                    <p class="text-muted mb-2">{{ current_user.email }}</p>
                    <div class="d-flex justify-content-around text-center mb-3">
                        <div>
                            <div class="fw-bold text-primary">{{ health_scores|length }}</div>
                            <small class="text-muted">Scores</small>
                        </div>
                        <div>
                            <div class="fw-bold text-success">{{ chat_history|length }}</div>
                            <small class="text-muted">Chats</small>
                        </div>
                    </div>
                    <p class="small text-muted mb-1">
                        <i class="fas fa-map-marker-alt"></i> {{ current_user.location }}
                    </p>
                    <p class="small text-muted">
                        <i class="fas fa-birthday-cake"></i> Age: {{ current_user.age }}
                    </p>
                </div>
            </div>

            <!-- Navigation -->
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="nav flex-column">
                        <button class="btn btn-outline-primary text-start mb-2 active" onclick="showSection('chat')">
                            <i class="fas fa-comment-medical"></i> Health Chat
                        </button>
                        <button class="btn btn-outline-success text-start mb-2" onclick="showSection('health')">
                            <i class="fas fa-chart-line"></i> Health Progress
                        </button>
                        <button class="btn btn-outline-info text-start mb-2" onclick="showSection('chat-history')">
                            <i class="fas fa-history"></i> Chat History
                        </button>
                        <button class="btn btn-outline-secondary text-start mb-2" onclick="showSection('profile')">
                            <i class="fas fa-user-cog"></i> Profile Settings
                        </button>
                    </div>
                </div>
            </div>

            <!-- Emergency Button -->
            <button class="btn btn-danger btn-lg w-100 mt-4 emergency-btn shadow" onclick="triggerEmergency()">
                <i class="fas fa-ambulance"></i> EMERGENCY
            </button>

            <!-- Quick Health Score -->
            {% if health_scores %}
            <div class="card mt-4 shadow-sm">
                <div class="card-body text-center">
                    <h6>Current Health Score</h6>
                    <div class="health-score-circle mx-auto mb-2">
                        {{ health_scores[0].score if health_scores else 'N/A' }}
                    </div>
                    <small class="text-muted">Last updated: {{ health_scores[0].date.strftime('%m/%d/%Y') if health_scores else 'Never' }}</small>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Main Content -->
        <div class="col-md-9">
            <!-- Chat Section -->
            <div id="chat-section" class="dashboard-section">
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-comment-medical"></i> Health Assistant</h5>
                    </div>
                    <div class="card-body">
                        <div id="chat-container" class="chat-container border rounded p-3 mb-3 bg-light">
                            <div class="alert alert-info">
                                <strong><i class="fas fa-robot"></i> HealthBot:</strong> 
                                Hello {{ current_user.name }}! I'm your health assistant. Describe your symptoms in English or Hindi, and I'll provide helpful advice.
                            </div>
                        </div>
                        <div class="input-group">
                            <input type="text" id="chat-input" class="form-control" 
                                   placeholder="Describe your symptoms in English or Hindi (e.g., सिरदर्द, fever, headache)..."
                                   onkeypress="if(event.key === 'Enter') sendMessage()">
                            <button class="btn btn-primary" onclick="sendMessage()">
                                <i class="fas fa-paper-plane"></i> Send
                            </button>
                        </div>
                        <div class="mt-2 text-center">
                            <small class="text-muted">
                                <i class="fas fa-language"></i> Supports English & Hindi | 
                                <i class="fas fa-shield-alt"></i> Your conversations are private
                            </small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Health Progress Section -->
            <div id="health-section" class="dashboard-section" style="display:none">
                <div class="card shadow-sm">
                    <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-chart-line"></i> Health Progress Tracking</h5>
                        <button class="btn btn-light btn-sm" onclick="updateHealthScorePrompt()">
                            <i class="fas fa-plus"></i> Add Score
                        </button>
                    </div>
                    <div class="card-body">
                        {% if chart_url %}
                        <div class="text-center mb-4">
                            <img src="{{ chart_url }}" alt="Health Progress Chart" class="img-fluid rounded shadow">
                        </div>
                        {% endif %}
                        
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Date</th>
                                        <th>Score</th>
                                        <th>Status</th>
                                        <th>Notes</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for score in health_scores %}
                                    <tr>
                                        <td>{{ score.date.strftime('%Y-%m-%d') }}</td>
                                        <td>
                                            <span class="badge bg-{% if score.score >= 80 %}success{% elif score.score >= 60 %}warning{% else %}danger{% endif %} fs-6">
                                                {{ score.score }}/100
                                            </span>
                                        </td>
                                        <td>
                                            {% if score.score >= 80 %}
                                                <span class="text-success"><i class="fas fa-smile"></i> Excellent</span>
                                            {% elif score.score >= 60 %}
                                                <span class="text-warning"><i class="fas fa-meh"></i> Good</span>
                                            {% else %}
                                                <span class="text-danger"><i class="fas fa-frown"></i> Needs Attention</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ score.notes or 'No notes' }}</td>
                                        <td>
                                            <button class="btn btn-sm btn-outline-danger" 
                                                    onclick="deleteHealthScore({{ score.id }})">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    {% else %}
                                    <tr>
                                        <td colspan="5" class="text-center text-muted py-4">
                                            <i class="fas fa-chart-line fa-3x mb-3"></i>
                                            <p>No health scores recorded yet.</p>
                                            <button class="btn btn-primary" onclick="updateHealthScorePrompt()">
                                                Add Your First Health Score
                                            </button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Chat History Section -->
            <div id="chat-history-section" class="dashboard-section" style="display:none">
                <div class="card shadow-sm">
                    <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-history"></i> Chat History</h5>
                        {% if chat_history %}
                        <button class="btn btn-light btn-sm" onclick="clearAllChats()">
                            <i class="fas fa-trash"></i> Clear All
                        </button>
                        {% endif %}
                    </div>
                    <div class="card-body">
                        {% if chat_history %}
                        <div style="max-height: 600px; overflow-y: auto;">
                            {% for chat in chat_history %}
                            <div class="card mb-3 shadow-sm">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <small class="text-muted">
                                            <i class="fas fa-clock"></i> {{ chat.timestamp.strftime('%Y-%m-%d %H:%M') }}
                                        </small>
                                        <button class="btn btn-sm btn-outline-danger" 
                                                onclick="deleteChat({{ chat.id }})">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                    <div class="user-message p-2 rounded mb-2">
                                        <strong><i class="fas fa-user"></i> You:</strong><br>
                                        {{ chat.message }}
                                    </div>
                                    <div class="bot-message p-2 rounded">
                                        <strong><i class="fas fa-robot"></i> HealthBot:</strong><br>
                                        {{ chat.response }}
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-comments fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No Chat History</h5>
                            <p class="text-muted">Your conversations with HealthBot will appear here.</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Profile Section -->
            <div id="profile-section" class="dashboard-section" style="display:none">
                <div class="card shadow-sm">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="mb-0"><i class="fas fa-user-cog"></i> Profile Settings</h5>
                    </div>
                    <div class="card-body">
                        <form id="profile-form">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Full Name *</label>
                                    <input type="text" class="form-control" name="name" value="{{ current_user.name }}" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Age *</label>
                                    <input type="number" class="form-control" name="age" value="{{ current_user.age }}" min="1" max="120" required>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Email Address</label>
                                <input type="email" class="form-control" value="{{ current_user.email }}" readonly>
                                <div class="form-text">Email cannot be changed</div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Location *</label>
                                <input type="text" class="form-control" name="location" value="{{ current_user.location }}" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Preferred Language</label>
                                <select class="form-select" name="language">
                                    <option value="en" {% if current_user.language == 'en' %}selected{% endif %}>English</option>
                                    <option value="hi" {% if current_user.language == 'hi' %}selected{% endif %}>Hindi (हिन्दी)</option>
                                </select>
                                <div class="form-text">HealthBot will respond in your preferred language</div>
                            </div>
                            <div class="text-end">
                                <button type="button" class="btn btn-primary" onclick="updateProfile()">
                                    <i class="fas fa-save"></i> Update Profile
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Health Score Modal -->
<div class="modal fade" id="healthScoreModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Update Health Score</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Health Score (0-100)</label>
                    <input type="range" class="form-range" id="health-score-range" min="0" max="100" value="50">
                    <div class="text-center">
                        <span id="score-display" class="fw-bold fs-4 text-primary">50</span>/100
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Notes (Optional)</label>
                    <textarea class="form-control" id="health-notes-input" rows="3" 
                              placeholder="How are you feeling today? Any specific concerns?"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="updateHealthScore()">Save Score</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Navigation
function showSection(section) {
    document.querySelectorAll('.dashboard-section').forEach(div => div.style.display = 'none');
    document.querySelectorAll('.btn-outline-primary').forEach(btn => btn.classList.remove('active'));
    document.getElementById(section + '-section').style.display = 'block';
    event.target.classList.add('active');
}

// Chat functionality
function sendMessage() {
    const input = document.getElementById('chat-input');
    const message = input.value.trim();
    if (message) {
        const chatContainer = document.getElementById('chat-container');
        // Add user message
        chatContainer.innerHTML += `
            <div class="d-flex justify-content-end mb-2">
                <div class="user-message p-2" style="max-width: 70%;">
                    <strong>You:</strong> ${message}
                </div>
            </div>
        `;
        input.value = '';
        
        // Show typing indicator
        chatContainer.innerHTML += `
            <div class="d-flex justify-content-start mb-2">
                <div class="bot-message p-2" style="max-width: 70%;">
                    <strong>HealthBot:</strong> <i class="fas fa-ellipsis-h"></i>
                </div>
            </div>
        `;
        chatContainer.scrollTop = chatContainer.scrollHeight;
        
        // Send to server
        fetch('/chat', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({message: message})
        })
        .then(r => r.json())
        .then(data => {
            // Remove typing indicator and add response
            chatContainer.querySelector('.fa-ellipsis-h').parentElement.parentElement.remove();
            chatContainer.innerHTML += `
                <div class="d-flex justify-content-start mb-2">
                    <div class="bot-message p-2" style="max-width: 70%;">
                        <strong>HealthBot:</strong> ${data.response}
                    </div>
                </div>
            `;
            chatContainer.scrollTop = chatContainer.scrollHeight;
        });
    }
}

// Health score functionality
function updateHealthScorePrompt() {
    const modal = new bootstrap.Modal(document.getElementById('healthScoreModal'));
    const range = document.getElementById('health-score-range');
    const display = document.getElementById('score-display');
    
    range.addEventListener('input', function() {
        display.textContent = this.value;
    });
    
    modal.show();
}

function updateHealthScore() {
    const score = document.getElementById('health-score-range').value;
    const notes = document.getElementById('health-notes-input').value;
    
    fetch('/health/score', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({score: score, notes: notes})
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('healthScoreModal')).hide();
            alert('Health score updated successfully!');
            location.reload();
        }
    });
}

function deleteHealthScore(scoreId) {
    if (confirm('Delete this health score record?')) {
        // Implement delete functionality if needed
        alert('Delete functionality would be implemented here');
    }
}

// Chat management
function deleteChat(chatId) {
    if (confirm('Delete this chat?')) {
        fetch(`/chat/delete/${chatId}`, {method: 'DELETE'})
        .then(r => r.json())
        .then(data => {
            if (data.success) location.reload();
        });
    }
}

function clearAllChats() {
    if (confirm('Clear all chat history? This cannot be undone.')) {
        // Implement clear all functionality
        alert('Clear all functionality would be implemented here');
    }
}

// Profile management
function updateProfile() {
    const form = document.getElementById('profile-form');
    const data = {
        name: form.name.value,
        age: form.age.value,
        location: form.location.value,
        language: form.language.value
    };
    
    fetch('/profile/update', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            alert('Profile updated successfully!');
            location.reload();
        }
    });
}

// Emergency functionality
function triggerEmergency() {
    if (confirm('🚨 EMERGENCY ALERT! This will notify emergency services with your location. Continue?')) {
        fetch('/emergency', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                alert(`🚑 EMERGENCY SERVICES NOTIFIED!\n\n${data.message}\n\nHospital: ${data.hospital.name}\nAddress: ${data.hospital.address}\nPhone: ${data.hospital.phone}\nDistance: ${data.hospital.distance}`);
            } else {
                alert('Emergency service temporarily unavailable. Please call local emergency services.');
            }
        });
    }
}

// Initialize
showSection('chat');
</script>

<style>
.health-score-circle {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    font-weight: bold;
    border: 4px solid #e9ecef;
}

.user-message {
    background: linear-gradient(135deg, #007bff, #0056b3);
    color: white;
}

.bot-message {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
}

.emergency-btn {
    background: linear-gradient(45deg, #ff416c, #ff4b2b);
    border: none;
    animation: pulse 2s infinite;
    font-weight: bold;
}

@keyframes pulse {
    0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 65, 108, 0.7); }
    50% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(255, 65, 108, 0); }
    100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 65, 108, 0); }
}

.chat-container {
    height: 400px;
    overflow-y: auto;
}

.btn-outline-primary.active {
    background-color: #007bff;
    color: white;
    border-color: #007bff;
}
</style>
{% endblock %}